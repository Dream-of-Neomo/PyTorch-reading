# 10. 여러 데이터 소스를 통합 데이터셋으로 합치기

#### Goal 🏃  
원본 CT 스캔 데이터와 데이터에 달아놓은 애노테이션 `annotation` 목록으로 훈련 샘플 만들기  
> Data annotation ❓  
> 데이터 애노테이션은 데이터셋에 메타 데이터를 추가하는 작업을 말한다. 태그 형식으로 인공지능이 데이터의 내용을 알아들을 수 있게 주석을 달아주는 작업이라고 할 수 있다. 데이터 라벨링이라고 불리기도 한다.

## 1. 원본 CT 데이터 파일

CT 데이터는 메타데이터 헤더 정보가 포함된 `.mhd` 파일과 3차원 배열을 만들 원본 데이터 바이트를 포함하는 `.raw` 파일로 총 2가지 종류이다.  
`Ct` 클래스는 두 파일을 읽어서 3차원 배열을 만들고 환자 좌표계를 배열에서 필요로 하는 인덱스, 행, 열 좌표로 바꿔주는 변환 행렬도 만든다.  
또한 LUNA에서 제공하는 애노테이션 데이터도 읽어야 한다. 이 데이터에는 각 결절의 좌표 목록, 악성 여부, 그리고 해당 CT 스캔의 시리즈 UID가 포함되어 있다. 
`(I,R,C)` 좌표를 사용하면 CT 데이터의 작은 3차원 부분 단면을 얻어 모델 입력값으로 사용할 수 있다. 이 3차원 배열과 함께 우리는 튜플의 나머지를 구성해야 한다. 여기에는 샘플 배열, 결절의 상태 플래그, 시리즈 UID를 비롯해 결절 후보군의 CT 리스트 중 이 샘플이 몇 번째 인덱스인지 등이 포함된다. 파이토치가 `Dataset` 서브클래스를 통해 얻고자 하는 것이 이 튜플이다. 이 튜플은 또한 원본 데이터를 파이토치 텐서로 바꿔주는 과정의 마지막 부분이다.  

## 2. LUNA 애노테이션 데이터 파싱
> Data Parsing ❓  
> 데이터 파싱은 한국어로는 구문 분석, 정제하기 등으로 불리며 데이터가 알맞은 문법에 맞게 정리되었는지 확인하고, 파싱하는 데이터를 목적에 맞게 이용하기 쉬운 형태로 구성해주는 것을 말한다.  
  
`candidates.csv` 파일을 파싱한다.
```console
(base) song-yeojin@song-yeojin-ui-MacBookAir code % wc -l candidates.csv
  551066 candidates.csv
(base) song-yeojin@song-yeojin-ui-MacBookAir code % head candidates.csv
seriesuid,coordX,coordY,coordZ,class
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,-56.08,-67.85,-311.92,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,53.21,-244.41,-245.17,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,103.66,-121.8,-286.62,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,-33.66,-72.75,-308.41,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,-32.25,-85.36,-362.51,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,-26.65,-203.07,-165.07,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,-74.99,-114.79,-311.92,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,-16.14,-248.61,-239.55,0
1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860,135.89,-141.41,-252.2,0
(base) song-yeojin@song-yeojin-ui-MacBookAir code % grep ",1$" candidates.csv | wc -l
       0
 ```
> 마지막 명령어가 잘 작동하지 않아서 Mac의 문제인가 싶어서 Google Colab에서도 해보았는데 여전히 안된다..아무래도 ,이나 $ 쪽에서 문제가 생긴 것 같은데 ㅠㅠ  
  
  코드를 보면 wc -l은 파일의 행 개수를 카운트한다. 즉 `candidates.csv`에는 총 551066개의 행이 있음을 알 수 있다.
