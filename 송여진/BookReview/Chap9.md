# 9. 암과 싸워 이기기 위한 파이토치 활용  
 
#### Goal 🏃
환자의 흉부 CT 스캔을 입력받아 악성 종양을 자동으로 탐지  
  
  
   
## 1. CT 스캔이란?  
CT는 `Computed Tomography`의 약자로, 컴퓨터 단층 촬영을 의미한다. 이 프로젝트에서의 CT 스캔은 단일 채널의 3차원 배열로 표현되는 3차원 엑스레이라고 할 수 있다. 흑백 PNG 이미지를 쌓아 놓은 것과 흡사하다. 여기서 복셀 `Voxel`이라는 개념이 등장한다.  
  

 >#### 복셀(Voxel)  
 > 💡 복셀이란 우리에게 친숙한 2차원 픽셀의 3차원 버전이다. 면적이 아닌 공간 용적을 담고 있으며 3차원 격자로 배열된다.   
 >각 차원 내에서는 거리를 측정할 수 있으며, 통상적으로 복셀은 정육면체이지만 이 프로젝트에서 다룰 복셀은 직육면체 모양을 띈다.  
 >의학 데이터 외에도 유체 시뮬레이션, 자율주행 자동차, 게임 등에서 복셀 데이터를 볼 수 있다.  
 >추가 참고: [Link](https://guwol.greenart.co.kr/community/greenDesignNews_view?idx=1641)
   
 CT 스캔 내의 각 복셀은 해당 위치에 있는 물체의 평균 질량 밀도를 나타내는 숫자 값을 가진다. 그래서 이 데이터들을 시각화하면 밀도가 높은 뼈나 금속 임플란트는 흰색으로 보이고 밀도가 낮은 공기나 폐 조직은 검게 보인다. 또한 지방이나 조직은 밝기가 다양한 회색으로 나타난다. 이렇게 보면 엑스레이와 유사해 보이지만 다른 점이 있다. 엑스레이는 3차원적인 강도(조직, 골밀도)를 2차원 평면에 투영한 것이지만 CT 스캔은 데이터의 3차원 형태를 보존한다. 따라서 다양한 방법으로 데이터를 가공하기에 용이하다.  
   
 <img src="https://upload.wikimedia.org/wikipedia/commons/f/ff/Image_of_3D_volumetric_QCT_scan.jpg?20121211122159" width="30%" height="30%"></img>  
 _사람 몸통의 스캔 이미지이다. 피부, 장기, 척추 등을 볼 수 있다._  

 CT 스캔과 엑스레이의 또 다른 차이점은 데이터가 디지털 포맷이라는 점이다. 스캔 과정의 원본 출력본은 사람이 구별할 수 있는 형태가 아니기 때문에 컴퓨터를 사용해 재해석해야 한다. 이때의 CT 스캐너 설정에 따라 출력 데이터는 크게 달라진다.
    
    
## 2. 엔드투엔드 폐암 진단기
 
 프로젝트 구성에 대해 생각해 보면, 디스크의 대부분은 CT 스캔의 3차원 배열을 저장하는 데 사용할 것이고 우리의 모델은 주로 3차원 배열에 해당하는 여러 단면을 사용할 것이다. 구체적으로는 흉부 CT 스캔 조사부터 환자에게 폐암 진단을 내리기까지 총 5개의 주요 단계를 거친다.  
 > #### 엔드투엔드 솔루션 `End-to-End solution`
 > 💡 입력부터 출력까지 파이프라인 네트워크 없이 한번에 처리한다는 의미이다. 장점으로는 신경망의 입력 및 출력을 직접 고려하여 네트워크 가중치를 최소화할 수 있다. 하지만 문제가 복잡할수록 효율성이 줄어든다. 
   
엔드투엔드 솔루션 과정은 먼저 CT 데이터 파일을 읽어서 CT 인스턴스를 만든 후, 전체 3차원 스캔 데이터를 담고 **세그멘테이션** `Segmentation`(관심있는 복셀 표시하기)을 수행하는 모듈과 결합한 후 추려진 복셀을 작은 덩어리로 나누어 결절로 간주될 만한 것을 찾는다. 
> #### 결절(nodule)
> 💡 증식하는 세포로 이뤄진 조직 덩어리를 종양(tumor)이라고 한다. 종양은 양성(benign) 또는 악성(malignant)으로 나뉘며, 악성일 경우 암(cancer)이라고도 한다. 폐에 있는 작은 종양을 페 결절(lung nodule)이라고 하며, 폐 결절의 약 40%는 악성인 것으로 알려져 있다. 따라서 최대한 초기에 잡아내는 것이 중요하다.

* **구체적으로 진행할 작업 프로세스**
1. 원본 CT 데이터를 파이토치로 사용할 수 있는 형태로 읽어들인다. 
2. 세그멘테이션 `Segmentation` 기술 구현을 위해 파이토치를 사용하여 폐의 잠재적 결절에 해당하는 복셀을 찾는다. 이는 히트맵 `heatmap`을 작성하는 것과 유사하다.
3. 관심 있는 복셀들을 덩어리(후보 결절)로 묶는다. 결절은 인덱스가 부여되며 열과 행으로 그 위치를 알 수 있다. 이렇게 묶인 덩어리들을 분류기에 전달한다.
4. 3차원 컨볼루션을 사용하여 각 후보 결절에 대해 실제 결절인지 아닌지로 분류한다. 
5. 각 결절별로 분류한 결과를 종합하여 환자를 진단한다.
  
### 2.1. 결절이란 무엇인가?

결절의 크기는 3cm 이하여야 하며, 이보다 큰 경우에는 폐 종괴 `lung mass`라고 부른다. 하지만 편의상 이 책에서는 동일한 해부학적 구조라면 모두 결절이라고 부르기로 한다. 핵심은 우리가 찾아내려는 결절은 모두 암의 형태를 띌 것이므로 모든 조직을 검사할 필요 없이 결절에만 집중하면 된다.


## 3. 데이터 소스 : LUNA 그랜드 챌린지

우리가 보는 CT 스캔은 모두 LUNA `LUng Nodule Analysis` 그랜드 챌린지에서 가져온 것이다. LUNA 그랜드 챌린지는 폐 결절이 있는 환자의 CT 스캔 자료를 고품질로 레이블 작업한 공개 데이터셋으로, 데이터 분류기 성능에 대한 공개 랭킹을 제공한다. 다만 공개 랭킹에 들어가려면 팀은 프로젝트의 구조와 훈련 방법을 기술한 과학 논문을 제출해야 한다.   
이 책에서는 LUNA 2016 데이터셋을 사용한다. [LUNA 사이트](https://luna16.grand-challenge.org/Description) 에서는 두 종류의 도전 기록을 볼 수 있는데 하나는 결절 탐지 `NDET`로 우리 프로젝트의 세그멘테이션 단계에 해당하며 다른 기록은 거짓 양성 감소 `FPRED`로 우리의 3번째 분류 단계와 유사하다. 



